<?xml version="1.0" ?>
<Graphs xmlns="https://poets-project.org/schemas/virtual-graph-schema-v4">
  <GraphType id="test_supervisor_100dev_to_sup_bcast_overload_gt">
    <SharedCode />

    <Properties>
      <![CDATA[
      uint32_t reps;
      uint32_t ndevs;
      ]]>
    </Properties>
    <MessageTypes>
      <MessageType id="msg">
        <Message><![CDATA[
        uint32_t to_send;  // If 1, then trigger another broadcast
        uint32_t delta_recv; // Contains the number of supervisor messages since the last message
        ]]></Message>
      </MessageType>
    </MessageTypes>

    <DeviceTypes>
      <DeviceType id="dev">
        <SharedCode />
        <Properties />
        <State>
            <![CDATA[
            uint32_t to_send;
            uint32_t delta_recv;
            ]]>
        </State>

        <SupervisorOutPin messageTypeId="msg">
          <OnSend><![CDATA[
            handler_log(1, "SupervisorOutPin");
            message->to_send=0;
            if(deviceState->to_send){
              message->to_send=1;
              deviceState->to_send -= 1;
            }
            message->delta_recv = deviceState->delta_recv;
            deviceState->delta_recv=0;
          ]]></OnSend>
        </SupervisorOutPin>
        <ReadyToSend><![CDATA[
        *readyToSend=0;
        if(deviceState->to_send || deviceState->delta_recv){
          *readyToSend |= RTS_SUPER_IMPLICIT_SEND_FLAG;
        }
        ]]></ReadyToSend>
        <OnInit>
        <![CDATA[
        deviceState->to_send=graphProperties->reps;
        deviceState->delta_recv=0;
        ]]></OnInit>

        <OnHardwareIdle/>
        <OnDeviceIdle/>
      </DeviceType>

      <SupervisorType id="sup">
        <Code />
        <Properties />
        <State><![CDATA[
        uint32_t seen;
        ]]></State>
        <OnInit><![CDATA[
          Super::post("SupervisorType::OnInit");
          supervisorState->seen = 0;
        ]]></OnInit>
        <SupervisorInPin id="" messageTypeId="msg">
          <OnReceive><![CDATA[
          supervisorState->seen += message->delta_recv;
          if(message->to_send){
            RTSBCAST();
          }
          if(supervisorState->seen == graphProperties->ndevs * graphProperties->reps){
            Super::post("_HANDLER_EXIT_SUCCESS_9be65737_");
            Super::stop_application();
          }
          ]]></OnReceive>
        </SupervisorInPin>
        <OnStop><![CDATA[
        ]]></OnStop>
      </SupervisorType>
    </DeviceTypes>
  </GraphType>
  <GraphInstance id="test_supervisor_100dev_to_sup_bcast_overload_gi" graphTypeId="test_supervisor_100dev_to_sup_bcast_overload_gt" P="{1,100}">
    <DeviceInstances>
          <DevI id="d00" type="dev" />
      <DevI id="d01" type="dev" />
      <DevI id="d02" type="dev" />
      <DevI id="d03" type="dev" />
      <DevI id="d04" type="dev" />
      <DevI id="d05" type="dev" />
      <DevI id="d06" type="dev" />
      <DevI id="d07" type="dev" />
      <DevI id="d08" type="dev" />
      <DevI id="d09" type="dev" />
          <DevI id="d10" type="dev" />
      <DevI id="d11" type="dev" />
      <DevI id="d12" type="dev" />
      <DevI id="d13" type="dev" />
      <DevI id="d14" type="dev" />
      <DevI id="d15" type="dev" />
      <DevI id="d16" type="dev" />
      <DevI id="d17" type="dev" />
      <DevI id="d18" type="dev" />
      <DevI id="d19" type="dev" />
            <DevI id="d20" type="dev" />
      <DevI id="d21" type="dev" />
      <DevI id="d22" type="dev" />
      <DevI id="d23" type="dev" />
      <DevI id="d24" type="dev" />
      <DevI id="d25" type="dev" />
      <DevI id="d26" type="dev" />
      <DevI id="d27" type="dev" />
      <DevI id="d28" type="dev" />
      <DevI id="d29" type="dev" />
            <DevI id="d30" type="dev" />
      <DevI id="d31" type="dev" />
      <DevI id="d32" type="dev" />
      <DevI id="d33" type="dev" />
      <DevI id="d34" type="dev" />
      <DevI id="d35" type="dev" />
      <DevI id="d36" type="dev" />
      <DevI id="d37" type="dev" />
      <DevI id="d38" type="dev" />
      <DevI id="d39" type="dev" />
            <DevI id="d40" type="dev" />
      <DevI id="d41" type="dev" />
      <DevI id="d42" type="dev" />
      <DevI id="d43" type="dev" />
      <DevI id="d44" type="dev" />
      <DevI id="d45" type="dev" />
      <DevI id="d46" type="dev" />
      <DevI id="d47" type="dev" />
      <DevI id="d48" type="dev" />
      <DevI id="d49" type="dev" />
            <DevI id="d50" type="dev" />
      <DevI id="d51" type="dev" />
      <DevI id="d52" type="dev" />
      <DevI id="d53" type="dev" />
      <DevI id="d54" type="dev" />
      <DevI id="d55" type="dev" />
      <DevI id="d56" type="dev" />
      <DevI id="d57" type="dev" />
      <DevI id="d58" type="dev" />
      <DevI id="d59" type="dev" />
            <DevI id="d60" type="dev" />
      <DevI id="d61" type="dev" />
      <DevI id="d62" type="dev" />
      <DevI id="d63" type="dev" />
      <DevI id="d64" type="dev" />
      <DevI id="d65" type="dev" />
      <DevI id="d66" type="dev" />
      <DevI id="d67" type="dev" />
      <DevI id="d68" type="dev" />
      <DevI id="d69" type="dev" />
            <DevI id="d70" type="dev" />
      <DevI id="d71" type="dev" />
      <DevI id="d72" type="dev" />
      <DevI id="d73" type="dev" />
      <DevI id="d74" type="dev" />
      <DevI id="d75" type="dev" />
      <DevI id="d76" type="dev" />
      <DevI id="d77" type="dev" />
      <DevI id="d78" type="dev" />
      <DevI id="d79" type="dev" />
            <DevI id="d80" type="dev" />
      <DevI id="d81" type="dev" />
      <DevI id="d82" type="dev" />
      <DevI id="d83" type="dev" />
      <DevI id="d84" type="dev" />
      <DevI id="d85" type="dev" />
      <DevI id="d86" type="dev" />
      <DevI id="d87" type="dev" />
      <DevI id="d88" type="dev" />
      <DevI id="d89" type="dev" />
            <DevI id="d90" type="dev" />
      <DevI id="d91" type="dev" />
      <DevI id="d92" type="dev" />
      <DevI id="d93" type="dev" />
      <DevI id="d94" type="dev" />
      <DevI id="d95" type="dev" />
      <DevI id="d96" type="dev" />
      <DevI id="d97" type="dev" />
      <DevI id="d98" type="dev" />
      <DevI id="d99" type="dev" />
    </DeviceInstances>
    <EdgeInstances>
    </EdgeInstances>
  </GraphInstance>
</Graphs>
